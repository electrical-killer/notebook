---
id: 1731504916
slug: /subject_embedded/Protocol/Ble/theory/1731504916
title: ble4.0协议基础帧结构
date: 2022-12-28
authors: Electrical Killer
tags: [protocal, ble]
keywords: [protocal, ble]
---


ble4.0协议基础帧结构

<!-- truncate -->

##  一. Controller 协议层构成

| 控制器层 | PHY    | 基带物理层 |
| -------- | ------ | ---------- |
| LL       | 链路层 |            |

### 1. 基带物理层

 BLE 使用 2.4GHz 工业, 科学, 医疗(ISM)频段  

|          |                    |                                                              |
| -------- | ------------------ | ------------------------------------------------------------ |
| 频段     | 2.4GHz             | 从 2400MHz~2483.5MHz 约 83.5MHz 的频谱资源 通用 无需授权     |
| 调制     | GFSK(高斯频移键控) | 比特率为 1Mbit/s(1Mbps)                                      |
| 射频信道 | 40个(ISM频段)      | `广播通道`: 3个固定, 分别是--37  38  39各个广播信道直接至少相差 `24MHz`各数据信道间隔 `2MHz``数据通道`: **27个自适应自动调频**`2402KHz <= 中心频率 f <= 2480KHz` |
| 功率     | -                  | 最小不低于 `10uW` == `-20dBm`最大不超于 `10mW` == `+10dBm`   |

### 2. 链路层

#### 2.1. 协议报文

##### 2.1.1. 帧格式

| Preamble - 前导码 | Access Address - 接入地址 | PDU - 协议数据单元 | CRC - 校验码 |
| ----------------- | ------------------------- | ------------------ | ------------ |
| 1 Byte            | 4 Byte                    | 2-39 Byte          | 3 Byte       |

##### 2.1.2. 帧分析

| 个字节   | 字节数    | 说明                                                         |
| -------- | --------- | ------------------------------------------------------------ |
| 前导码   | 1 Byte    | 硬件实现当接入地址最低位==0, 前导码为  `0xAA`   10101010b  当接入地址最低位==1, 前导码为  `0x55`    01010101b |
| 接入地址 | 4 Byte    | 广播接入地址固定为 ` 0x8e89bed6 ` 数据接入地址 为随机数主机随机产生, 发送从机 |
| PDU      | 2-39 Byte | 协议数据单元                                                 |
| CRC      | 3 Byte    | 对整个 PDU 校验                                              |

#### 2.2. 协议字中PDU数据格式

| 报头         | 长度         | 数据净荷(payload) |
| ------------ | ------------ | ----------------- |
| 1 Byte-8 bit | 1 Byte-8 bit | 0-37 Byte         |

##### 2.2.1. 广播通道

| PDU格式         | 详细         | Bit                      | 说明                                     |                               |
| --------------- | ------------ | ------------------------ | ---------------------------------------- | ----------------------------- |
| 报头1 Byte      | 报文类型     | LSB  4(最低有效位)       | ADV_IND                                  | 非定向连接广播通用-上电可广播 |
| ADV_DIRECT_IND  | 定向连接广播 |                          |                                          |                               |
| ADV_NONCONN_IND | 不可连接广播 |                          |                                          |                               |
| ADV_SCAN_IND    | 可扫描广播   |                          |                                          |                               |
| SCAN_REQ        | 主动扫描广播 |                          |                                          |                               |
| SCAN_RSP        | 主动扫描应答 |                          |                                          |                               |
| CONNECT_REQ     | 连接请求     |                          |                                          |                               |
| RFU保留         | 2            | -                        |                                          |                               |
| 发送地址        | 1            | ==1 随机地址==0 公共地址 | 标志位                                   |                               |
| 接收地址        | 1            |                          |                                          |                               |
| 长度1 Byte      | 数据净荷长度 | 6                        | 数据净荷长度                             |                               |
| RFU保留         | MSB  2       | -                        |                                          |                               |
| 数据净荷37 Byte | 数据净荷     | 0-296(37 Byte)           | 6 byte 地址 (AdvA)+31 byte Date(AdvData) |                               |

##### 2.2.2. 数据通道

- 通道中PDU数据格式有两个类型

- 数据报文类型
- 控制报文类型

- 这里的有效净荷数据长度最大只有 216 bit--27Byte
- 加上 MIC 的 4Byte == 31Byte
- 依旧缺少 6Byte

- **协议规范**       

- **在广播通道这 6 个字节是设备地址**
- **数据通道规定最大的净荷包不能超过 27Byte**
- **无论是否存在 MIC**



| PDU格式            | 详细                 | NAME   | Bit                                                          | 说明         |          |
| ------------------ | -------------------- | ------ | ------------------------------------------------------------ | ------------ | -------- |
| 报头1 Byte         | 链路标识符           | LLID   | LSB 2                                                        | 00b          | Reserved |
| 01b                | LL Data PDU          |        |                                                              |              |          |
| 10b                | LL Data PDU          |        |                                                              |              |          |
| 11b                | LL Control PDU       |        |                                                              |              |          |
| 期望下一报文序列号 | NESN                 | 1      | 判断数据包是否被正确接收还是需要重发例如: ( 如下图  数据报头标志位应用   )M==>S 第一包SN==0  NESN==0M==>S 如果第二包 NESN==0 重发 |              |          |
| 报文序列号         | SN                   | 1      | 第一包数据为0, 新包与前一包相反(用于重发报文机制)            |              |          |
| 更多数据           | MD                   | 1      | 决定是否为最后一包没有数据后, 连接立刻断开                   |              |          |
| 保留               | DFU                  | 3      | -                                                            |              |          |
| 长度1 Byte         | 数据净荷长度         | Length | 5                                                            | 数据净荷长度 |          |
| RFU保留            | DFU                  | MSB  3 | -                                                            |              |          |
| 数据净荷27 Byte    | 数据净荷             | -      | 0-216(27 Byte)                                               | -            |          |
| MIC4 Byte          | 信息完整性检测(加密) | MIC    | 32(4 Byte)                                                   | -            |          |

![img](https://cdn.nlark.com/yuque/0/2022/png/23063586/1646820832105-59dae420-94ac-4356-ad71-21e142f0dcaa.png?x-oss-process=image%2Fresize%2Cw_548%2Climit_0)

### 3. 链路层状态

- **状态状态流程图**

![img](https://cdn.nlark.com/yuque/0/2022/png/23063586/1646806303211-52cf9f84-9a38-4fa0-aeab-642334bde670.png)

- **状态描述一览**

| 状态   | 可以干什么                                                   | 如何进入其他状态                                        | 如何进入本状态                                |
| ------ | ------------------------------------------------------------ | ------------------------------------------------------- | --------------------------------------------- |
| 就绪态 | -                                                            | `其他四种状态`- 接收主机命令                            | 上电默认`广播态`- 停止广播`发起态`- 超时      |
| 广播态 | 广播报文发送扫描响应回应主动扫描设备                         | `就绪态`- 停止广播`连接态`- 收到主机的连接请求          | `就绪态`进入                                  |
| 扫描态 | `被动扫描`接收机中控制成本, 不能发报`主动扫描`发现广播态设备请求扫描, 等待ACK | -                                                       | `就绪态`进入                                  |
| 发起态 | 发送连接请求后, 进入 `数据通道`如果有ACK, 进 `连接态`超时, 进 `就绪态` | `连接态`- 收到ACK`就绪态`- 超时                         | `就绪态`进入                                  |
| 连接态 | -                                                            | `主机`- `发起态`- 收到ACK`从机`- `广播态`- 收到主机请求 | `连接态`- 收到ACK`连接态`- 收到主机的连接请求 |



#### 3.1. 就绪态

默认状态, 可进入其他三态

#### 3.2. 广播态

|                               | 事件名             | 事件名                                                       | 广播时间间隔 (限非定向广播)                                  | 说明         |
| ----------------------------- | ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------ |
| 广播事件                      | ADV_IND            | 非定向连接事件(通用广播)                                     | 连续的广播必须小于等于 `10ms`不连续的广播事件 大于等于 `20ms` | 为了建立连接 |
| ADV_DIRECT_IND                | 定向连接事件       | 特殊时序要求 : 完整的广播事件必须每 `3.75ms`周期内重复一次并且不能持续 `1.28s`以上 | 为了 **快速** 建立连接超时后使用通用广播                     |              |
| ADV_NONCONN_IND               | 非定向不可连接事件 | 大于等于 `100ms`                                             | 只为广播事件中发送数据唯一可用于没有接收设备的广播类型       |              |
| ADV_SCAN_IND ADV_DISCOVER_IND | 非定向扫描事件     | 大于等于 `100ms`                                             | 不能建立连接, 只能处在广播 就绪态适用与广播数据动态数据-包含广播数据中静态数据-包含在扫描响应中 |              |

##### 3.2.1. 应答与对应广播事件

|                                             | SCAN_REQ扫描请求 | CONNECT_REQ连接请求      | SCAN_RSP扫描请求应答                 |
| ------------------------------------------- | ---------------- | ------------------------ | ------------------------------------ |
| ADV_IND 非定向连接事件                      | YES              | YES(进入连接态 - 无应答) | 接收到的 SCAN_REQ 通过滤波政策  回复 |
| ADV_DIRECT_IND定向连接事件                  | NO               | YES(地址匹配)            | -                                    |
| ADV_NONCONN_IND非定向不可连接事件           | NO               | NO                       | -                                    |
| ADV_SCAN_IND ADV_DISCOVER_IND非定向扫描事件 | YES              | NO                       | YES                                  |



#### 3.3. 扫描态

**扫描窗口 <= 扫描间隔**

##### 3.3.1. 扫描窗口

- LL层监听广播通道的持续时间
- 0 < t <= 10.24
- 当扫描窗口等于扫描间隔时, 相当于连续扫描

##### 3.3.2. 扫描间隔

两个连续扫描窗口开始之间的时间

#### 3.4. 发起态

成为主机设备

工作: 

- 扫描态事件之后 发送连接请求, 等待回复
- 接收到连接ACK后, 进入连接态



#### 3.5. 连接态

**连接事件参数描述**

- connInterval

- 连接间隔

-  connSlaveLatency  

- 从机潜伏期

-  anchor point

-  锚点  

-  主机在锚点开始连接事件，从机需要 在锚点前进入侦听状态。  

-  connEventCounter

- 连接事件计数器



### 4. nrf51822的Radio

#### 4.1. 包结构

![img](https://cdn.nlark.com/yuque/0/2022/png/23063586/1646875799672-b6e34d11-7026-45cd-996c-cb4b6d516c1b.png)

|                  |                  |                                                              |
| ---------------- | ---------------- | ------------------------------------------------------------ |
| 前导码1 Byte     | -                |                                                              |
| 接入地址4 Byte   | -                | 例如广播地址为  0x8e89bed6 == BASE0+PREFIX0**BASE0=0x89bed600 (截取低字节) ****PREFIX0=0x8e** |
| PDU0-39 Byte     | S01 Byte         | 报头                                                         |
| Length1 Byte     | Length + S1长度  |                                                              |
| PAYLOAD0-37 Byte | 净荷包中有效字节 |                                                              |
| CRC3 Byte        | -                | PDU校验                                                      |

**设备地址 与 接入地址**

注: 

该地址全球唯一

- 6字节固定分配
- 连接成功后, 设备地址被存入 `白名单` 中

#### 4.2. Radio 状态机

![img](https://cdn.nlark.com/yuque/0/2022/png/23063586/1646877789553-76e8eeef-4865-467a-a300-4ff75d96db26.png?x-oss-process=image%2Fresize%2Cw_750%2Climit_0)

## 二. HOST 主机层

### 1. 主机数据流向

![img](https://cdn.nlark.com/yuque/0/2022/png/23063586/1647501076165-a8daaea3-e988-41cd-9b77-3720367e47e3.png)

### 2. L2CAP - 数据通道

![img](https://cdn.nlark.com/yuque/0/2022/png/23063586/1647499321259-d8831610-12f4-4572-9787-d9129bda9bdf.png)

#### 2.1. L2CAP 作用



控制器链路层数据到达主机后, 由该层进行疏导



#### 2.2. L2CAP 信道



低功耗蓝牙中, 该层由3个固定通道(信道)



| L2CAP层信道ID | Description                        | 说明                   | 对接上层协议                    |
| ------------- | ---------------------------------- | ---------------------- | ------------------------------- |
| 0x0004        | Attribute Protocol                 | 属性协议               | ATT 属性协议                    |
| 0x0005        | Low Energy L2CAP Signaling channel | 低功耗信令信道固定信道 | GAP 通用访问规范  -- (只供数据) |
| 0x0006        | Security Manager Protocol          | 安全管理协议           | SMP 安全管理协议                |

1. GAP访问规范 两种途径可以传输数据到底层

1. 直接到底层 (初始化参数)
2. 通过L2CAP数据到底层 (动态数据)

1. 属性

1. 数据按一定的规则存放在 `GATT`中

1.  Profile  

1. 根据属性和应用做的模子

1. GATT

1. 根据 Profile  做成的数据库

1. ATT

1. 规定了 **属性** 怎么访问和运输



####  2.3. L2CAP 数据包格式  



| header | payload    |                     |
| ------ | ---------- | ------------------- |
| Length | Channel ID | Information payload |
| 2 Byte | 2 Byte     | 23 Byte             |

因为payload 字节少, 需要分包, LL 层报头才有MD标志存在

#### 2.4. L2CAP 低功耗信道包格式( ID:0x0005 )

|             |                                      | 操作码                       |          |      |
| ----------- | ------------------------------------ | ---------------------------- | -------- | ---- |
| Code        | Byte 0 (LSB)                         | 0x00                         | Reserved | 保留 |
| 0x01        | Command reject                       | 命令拒绝                     |          |      |
|             |                                      |                              |          |      |
| 0x12        | Connection Parameter Update request  | 连接参数更新请求             |          |      |
| 0x13        | Connection Parameter Update response | 连接参数更新应答             |          |      |
| Indentifier | Byte 1                               | 标识符                       |          |      |
| Length      | Byte 2-3 ( MSB )                     | 长度                         |          |      |
| Data        | <= 23Byte                            | 每个操作码都有固定格式的数据 |          |      |



##### 2.4.1. 0x01 命令拒绝

|                        | Byte 0                           | Byte 1             | Byte 2-3   |
| ---------------------- | -------------------------------- | ------------------ | ---------- |
|                        | Code == 0x01                     | Indentifier        | Length     |
| Data                   | 原因码  Reason  2Byte            | 0x0000 ( 无 Data ) | 不理解命令 |
| 0x0001                 | 超出最大传输字节数               |                    |            |
| Data (Optional) 2 Byte | 2Byte 应答可接受的最大数据为多少 |                    |            |



##### 2.4.2. 0x12 连接参数更新请求和应答

| Byte 0                                                       | Byte 1      | Byte 2-3 |
| ------------------------------------------------------------ | ----------- | -------- |
| Code == 0x12                                                 | Indentifier | Length   |
| 有四个参数都是给的范围从机被动接受主机的要求, 如果主机同意修改则修改, 不同意会收到主机命令拒绝拒绝码为 Reason = 0x0001 |             |          |
|                                                              |             |          |

### 3. ATT - 属性协议

应用于数据库的读写时的协议

三个方面协议

- 通信方式

| 通信方式 - PDU类型   | Send By | 描述                                   | 是否互为原子操作 |
| -------------------- | ------- | -------------------------------------- | ---------------- |
| 请求 -- Request      | Client  | 客户端请求数据                         | 原子操作         |
| 应答 -- Response     | Server  | 服务器对上面请求应答                   |                  |
| 命令 -- Comand       | Client  | 客户端向服务器发送命令 -- 无应答       | 无操作           |
| 通知 -- Notification | Server  | 服务器对特性数值向客户端通知 -- 无应答 |                  |
| 指示 -- Indication   | Server  | 服务端对特性数据值指示给客户端         | 原子操作         |
| 确认 -- Confirmation | Client  | 客户端对指示的应答                     |                  |

- 通信包格式
- 具体通信数据包

### 4. GATT - 数据库

属性构成 就是 数据按一定的格式 存储

#### 4.1. 属性-数据存放规则

| Attribute Handle - 属性句柄      | 2 Bytes     | 用来寻找和操作属性                              |
| -------------------------------- | ----------- | ----------------------------------------------- |
| Attribute Type  - 属性类型       | 2/16 Bytes  |                                                 |
| Attribute Value - 属性值         | 0-512 Bytes | UUID（128 bites）单位属性类型特性描述符特性类型 |
| 给应用的值                       |             |                                                 |
| Attribute Permissions - 属性许可 | 区分        | 使用许可                                        |
| 认证许可                         |             |                                                 |
| 授权许可                         |             |                                                 |

#### 4.2. GATT服务器构成 - GATT Profile

| Profile - 基本单元包含==>           | Service - 服务声明包含==> | Include - 包含引用服务 -（可有） |
| ----------------------------------- | ------------------------- | -------------------------------- |
| Characteristic - 强制性和可选的特征 |                           |                                  |

## 附录: 其他

### MIC- 信息完整性检测

为了保证数据的正确性

占有4Byte

涉及到数据加密操作

并非一定加密

如下情况**不需要MIC**

-  没有加密的链路层连接
-  有加密的链路连接, 但是发送的是空包  

### 自适应调频-信道

该方法可确保传输质量, 减少其他设备对数据报文的传输干扰

经过调频计算

记录好, 坏信道的对应映射关系

### 存储方式

**小端模式**

### 数据传输方式

- **高位先行**

- CRC  循环冗余校验
- MIC   信息完整性检查  

- **低位先行**

- 其他所有数据